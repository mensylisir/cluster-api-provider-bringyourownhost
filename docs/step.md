## ğŸ“‹ éœ€è¦åˆ›å»ºçš„å®Œæ•´èµ„æºæ¸…å•

æ˜¯çš„ï¼éœ€è¦åˆ›å»ºä»¥ä¸‹èµ„æºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æ‰‹åŠ¨åˆ›å»º                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Cluster                                                     â”‚
â”‚ 2. ByoCluster                                                  â”‚
â”‚ 3. ByoMachineTemplate (MachineDeployment å¼•ç”¨å®ƒ)                â”‚
â”‚ 4. MachineDeployment (CAPI ä¼šè‡ªåŠ¨åˆ›å»º Machine)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAPI è‡ªåŠ¨åˆ›å»º                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. Machine (æ ¹æ® MachineDeployment è‡ªåŠ¨åˆ›å»º)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BYOH æ§åˆ¶å™¨è‡ªåŠ¨åˆ›å»º                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. ByoMachine (æ ¹æ® Machine è‡ªåŠ¨åˆ›å»º)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



## ğŸ“ å®Œæ•´ YAML é…ç½®æ–‡ä»¶

åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ `cluster-setup.yaml`ï¼š

```
---
# 1. ByoMachineTemplate - å®šä¹‰æ–°èŠ‚ç‚¹çš„é…ç½®
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: ByoMachineTemplate
metadata:
  name: md-0
  namespace: default
spec:
  template:
    spec:
      # TLS Bootstrapæ¨è æ¨¡å¼ï¼ˆï¼Œç”¨äºå·²æœ‰é›†ç¾¤ï¼‰
      joinMode: tlsBootstrap
      # K8s ç‰ˆæœ¬
      kubernetesVersion: v1.28.0
      # ä¸‹è½½æ¨¡å¼ï¼šonline ä»ç½‘ç»œä¸‹è½½ï¼Œoffline ç”¨æœ¬åœ° bundle
      downloadMode: online
---
# 2. MachineDeployment - å®šä¹‰è¦æ‰©å®¹çš„èŠ‚ç‚¹
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachineDeployment
metadata:
  name: md-0
  namespace: default
spec:
  clusterName: my-cluster
  replicas: 1  # è¦æ·»åŠ å‡ ä¸ªèŠ‚ç‚¹å°±å¡«å‡ 
  selector:
    matchLabels: null
  template:
    metadata:
      labels:
        nodepool: pool1
    spec:
      clusterName: my-cluster
      version: v1.28.0  # K8s ç‰ˆæœ¬
      # å¼•ç”¨ ByoMachineTemplate
      infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: ByoMachineTemplate
        name: md-0
        namespace: default
---
# 3. Cluster - å®šä¹‰é›†ç¾¤ï¼ˆå¿…é¡»å…ˆåˆ›å»º Cluster å’Œ ByoClusterï¼‰
apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: my-cluster
  namespace: default
spec:
  # ç½‘ç»œé…ç½®
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
    services:
      cidrBlocks:
      - 10.96.0.0/12
  # æ§åˆ¶å¹³é¢ç«¯ç‚¹ï¼ˆä½ çš„ç°æœ‰é›†ç¾¤ API Serverï¼‰
  controlPlaneEndpoint:
    host: 192.168.1.100  # æ›¿æ¢ä¸ºä½ çš„ API Server IP
    port: 6443
  # å…³é”®ï¼éƒ½æŒ‡å‘ ByoCluster
  controlPlaneRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: ByoCluster
    name: my-cluster
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: ByoCluster
    name: my-cluster
---
# 4. ByoCluster - BYOH ç‰¹æœ‰çš„é›†ç¾¤å®šä¹‰
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: ByoCluster
metadata:
  name: my-cluster
  namespace: default
spec:
  controlPlaneEndpoint:
    host: 192.168.1.100  # æ›¿æ¢ä¸ºä½ çš„ API Server IP
    port: 6443
  # å¯é€‰ï¼šBundle ä»“åº“åœ°å€
  # bundleLookupBaseRegistry: projects.registry.vmware.com/byoh
```



## ğŸš€ éƒ¨ç½²æ­¥éª¤

```
# 1. å…ˆåˆ›å»º Cluster å’Œ ByoCluster
kubectl apply -f cluster-setup.yaml -l "kind in (Cluster,ByoCluster)"

# 2. æ£€æŸ¥çŠ¶æ€
kubectl get cluster,byocluster

# 3. ç¡®è®¤ Cluster çŠ¶æ€å˜ä¸º ready
kubectl get cluster my-cluster -o jsonpath='{.status.infrastructureReady}'
kubectl get cluster my-cluster -o jsonpath='{.status.controlPlaneReady}'

# 4. ç„¶ååˆ›å»º MachineDeployment å’Œ ByoMachineTemplate
kubectl apply -f cluster-setup.yaml -l "kind in (MachineDeployment,ByoMachineTemplate)"

# 5. æ£€æŸ¥ MachineDeployment
kubectl get machinedeployment

# 6. æ£€æŸ¥ Machine æ˜¯å¦è‡ªåŠ¨åˆ›å»º
kubectl get machine

# 7. æ£€æŸ¥ ByoMachine æ˜¯å¦è‡ªåŠ¨åˆ›å»º
kubectl get byomachine
```



## ğŸ“Š åˆ›å»ºé¡ºåºï¼ˆé‡è¦ï¼ï¼‰

```
ç¬¬ä¸€æ­¥ï¼škubectl apply -f cluster-setup.yaml  # åŒ…å« Cluster å’Œ ByoCluster
         â†“
ç¬¬äºŒæ­¥ï¼šç¡®è®¤ Cluster çŠ¶æ€
         kubectl get cluster my-cluster
         # æœŸæœ›çœ‹åˆ° infrastructureReady=true, controlPlaneReady=true
         â†“
ç¬¬ä¸‰æ­¥ï¼škubectl apply -f cluster-setup.yaml  # åŒ…å« MachineDeployment å’Œ ByoMachineTemplate
         â†“
ç¬¬å››æ­¥ï¼šæ£€æŸ¥è‡ªåŠ¨åˆ›å»ºçš„èµ„æº
         kubectl get machine,byomachine,byohost
```



## ğŸ” éªŒè¯å‘½ä»¤

```
# æŸ¥çœ‹æ‰€æœ‰èµ„æº
kubectl get cluster,byocluster,machinedeployment,machine,byomachine,byohost

# æŸ¥çœ‹ Machine çŠ¶æ€
kubectl get machine -o wide

# æŸ¥çœ‹ ByoMachine çŠ¶æ€å’Œæ¡ä»¶
kubectl get byomachine -o yaml | grep -A 20 "status:"

# æŸ¥çœ‹ BYOH æ§åˆ¶å™¨æ—¥å¿—
kubectl logs -n byoh-system -l control-plane=controller-manager -f
```



------

## âš ï¸ é‡è¦æé†’

1. **Cluster å’Œ ByoCluster å¿…é¡»åŒå**ï¼ˆéƒ½æ˜¯ `my-cluster`ï¼‰
2. **MachineDeployment.spec.clusterName å¿…é¡»å’Œ Cluster åŒå**
3. **å…ˆåˆ›å»º Cluster/ByoClusterï¼Œç¡®è®¤å®ƒä»¬çŠ¶æ€ ready åå†åˆ›å»º MachineDeployment**
4. **ByoHost éœ€è¦å…ˆæ³¨å†Œå¥½**ï¼ˆåœ¨ä½ çš„æ–°èŠ‚ç‚¹ä¸Šå¯åŠ¨ agentï¼‰

æ˜å¤©åˆ°å…¬å¸åï¼Œå…ˆæ‰§è¡Œ `kubectl get cluster,byocluster,machinedeployment,machine,byomachine,byohost` æŠŠç»“æœå‘ç»™æˆ‘ï¼